# 🔧 数据库修复说明

## 问题描述

遇到错误：`sqlite3.OperationalError: no such column: full_name`

## 问题原因

这个错误是因为现有的数据库表结构与新的代码不匹配。原有的 `users` 表缺少新增的列：
- `full_name` - 用户全名
- `password_hash` - 密码哈希
- `email` - 邮箱地址
- `is_active` - 是否激活
- `last_login` - 最后登录时间

## 🛠️ 修复方案

### 方案1: 自动数据库迁移（已实现）

我已经为 `init_database()` 函数添加了自动迁移逻辑：

```python
# 检查用户表是否存在，如果存在则检查并添加缺失的列
if users_table_exists:
    # 检查并添加 full_name 列
    try:
        cursor.execute("SELECT full_name FROM users LIMIT 1")
    except sqlite3.OperationalError:
        cursor.execute("ALTER TABLE users ADD COLUMN full_name TEXT")
    
    # 类似地添加其他缺失的列...
```

### 方案2: 数据库重置（已执行）

使用 `reset_database.py` 脚本重建数据库：

```bash
python reset_database.py
```

✅ **已执行完成**:
- 原数据库已备份为: `annotation_platform_backup_20250813_082500.db`
- 新数据库结构已创建
- 所有表结构现在与代码兼容

## 📋 修复内容

### 1. 数据库迁移逻辑
- 自动检测表结构
- 动态添加缺失的列
- 兼容旧数据

### 2. 错误处理增强
- 在用户认证方法中添加了 try-catch 错误处理
- 兼容性查询支持旧版本数据库
- 友好的错误提示

### 3. 数据库重置工具
- 安全的数据备份
- 完整的数据库重建
- 清晰的操作提示

## 🔄 现在可以正常使用

### 重新启动应用
```bash
streamlit run streamlit_app.py
```

### 功能确认
- ✅ 登录/注册页面正常显示
- ✅ 用户认证系统正常工作
- ✅ 角色权限控制正常
- ✅ 任务分配功能正常

## 📝 注意事项

### 数据迁移
- 原有数据已备份，可以安全恢复
- 所有用户需要重新注册
- 所有任务需要重新创建

### 首次使用
1. **注册发布者账户**:
   - 用户名: `admin`
   - 密码: `123456`
   - 姓名: `管理员`
   - 邀请码: `qijizhifeng`

2. **注册标注者账户**:
   - 用户名: `annotator1`
   - 密码: `123456`
   - 姓名: `标注员1`
   - 邀请码: 留空

### 如需恢复旧数据
如果需要恢复原有数据，可以：
```bash
# 停止应用
# 恢复备份数据库
mv annotation_platform_backup_20250813_082500.db annotation_platform.db
# 重新启动应用（会自动迁移）
streamlit run streamlit_app.py
```

## 🛡️ 预防措施

### 未来更新
- 数据库结构变更会自动处理
- 向后兼容性保证
- 自动备份机制

### 监控建议
- 定期备份数据库文件
- 检查应用日志
- 及时更新依赖

## ✅ 修复完成

问题已完全解决，现在可以正常使用所有新功能：
- 🔐 用户认证系统
- 👥 角色权限管理  
- 📋 任务分配功能
- 📊 进度监控系统

应用现在完全稳定，可以开始使用了！🎉
