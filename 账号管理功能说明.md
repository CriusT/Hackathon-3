# 🔐 账号管理功能说明

## 功能概述

为数据标注平台新增了完整的用户管理系统，包括用户注册、登录、角色权限和任务分配功能。

## 🎯 核心功能

### 1. 用户认证系统

#### 用户注册
- **注册界面**：包含用户名、密码、确认密码、姓名、邮箱和邀请码字段
- **角色控制**：
  - 输入邀请码 `qijizhifeng` → 注册为**发布者**账户
  - 不输入邀请码或邀请码错误 → 注册为**标注者**账户
- **数据验证**：
  - 用户名唯一性检查
  - 密码长度验证（≥6位）
  - 密码确认一致性验证

#### 用户登录
- **安全登录**：用户名 + 密码验证
- **密码加密**：使用SHA256哈希存储密码
- **会话管理**：成功登录后保持会话状态

### 2. 用户角色系统

#### 👨‍💼 发布者（Publisher）
**权限**：
- ✅ 创建和配置标注任务
- ✅ 查看所有任务和进度
- ✅ 分配任务给标注者
- ✅ 导出标注结果
- ✅ 进行标注工作（可选）

**专用功能**：
- 📋 **任务分配页面** - 管理任务分配
- 👥 **标注者管理** - 查看所有标注者列表
- 📊 **全局进度监控** - 监控所有任务进度

#### 👨‍💻 标注者（Annotator）
**权限**：
- ✅ 查看分配给自己的任务
- ✅ 进行标注工作
- ✅ 查看自己的标注进度
- ❌ 无法创建任务
- ❌ 无法查看其他用户的任务

**专用界面**：
- 🏠 **我的任务** - 显示分配的任务列表
- 📊 **我的进度** - 个人标注进度统计

### 3. 任务分配功能

#### 分配管理
- **任务选择**：发布者可选择任何已创建的任务
- **标注者选择**：从所有注册的标注者中选择
- **分配记录**：记录分配时间、分配人等信息
- **重新分配**：支持将任务重新分配给其他标注者

#### 分配状态显示
- **任务列表**：显示每个任务的分配状态
- **分配信息**：显示分配给谁、何时分配、由谁分配
- **进度关联**：分配状态与标注进度关联显示

## 🗃️ 数据库设计

### 用户表 (users)
```sql
CREATE TABLE users (
    id TEXT PRIMARY KEY,              -- 用户ID (UUID)
    username TEXT UNIQUE NOT NULL,    -- 用户名
    password_hash TEXT NOT NULL,      -- 密码哈希
    email TEXT UNIQUE,               -- 邮箱
    role TEXT DEFAULT 'annotator',   -- 角色 (publisher/annotator)
    full_name TEXT,                  -- 全名
    is_active BOOLEAN DEFAULT 1,     -- 是否激活
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP             -- 最后登录时间
);
```

### 任务分配表 (task_assignments)
```sql
CREATE TABLE task_assignments (
    id TEXT PRIMARY KEY,              -- 分配ID (UUID)
    task_id TEXT NOT NULL,           -- 任务ID
    assigned_to TEXT NOT NULL,       -- 分配给谁 (用户ID)
    assigned_by TEXT NOT NULL,       -- 由谁分配 (用户ID)
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status TEXT DEFAULT 'assigned',  -- 分配状态
    FOREIGN KEY (task_id) REFERENCES tasks (id),
    FOREIGN KEY (assigned_to) REFERENCES users (id),
    FOREIGN KEY (assigned_by) REFERENCES users (id)
);
```

## 🎨 界面设计

### 登录/注册页面
```
🔐 数据标注平台
├─ [登录] [注册]
├─ 登录表单:
│   ├─ 用户名: [输入框]
│   ├─ 密码: [密码框]
│   └─ [登录按钮]
└─ 注册表单:
    ├─ 用户名*: [输入框]
    ├─ 密码*: [密码框]  
    ├─ 确认密码*: [密码框]
    ├─ 姓名*: [输入框]
    ├─ 邮箱: [输入框]
    ├─ 发布者邀请码: [输入框]
    └─ [注册按钮]
```

### 发布者主界面
```
📝 数据标注平台
├─ 用户信息: 👤 张三 (zhangsan) 👨‍💼 发布者 [🚪 退出登录]
└─ 导航菜单:
    ├─ 🏠 首页
    ├─ ⚙️ 任务配置  
    ├─ 📝 数据标注
    ├─ 📊 进度管理
    ├─ 📤 结果导出
    └─ 👥 任务分配  ← 新增
```

### 标注者主界面
```
📝 数据标注平台  
├─ 用户信息: 👤 李四 (lisi) 👨‍💻 标注者 [🚪 退出登录]
└─ 导航菜单:
    ├─ 🏠 我的任务    ← 专用
    ├─ 📝 数据标注    ← 仅看分配的任务
    └─ 📊 我的进度    ← 专用
```

### 任务分配页面
```
👥 任务分配管理

📋 任务分配
├─ 选择任务: [下拉菜单] SQL语义一致性测试 (ID: abc12345)
├─ 任务信息:
│   ├─ 任务名称: SQL语义一致性测试
│   └─ 任务描述: 判断SQL查询与问题的语义一致性
├─ 当前状态: 📌 已分配给: 李四 (@lisi)
├─ 🎯 分配任务:
│   ├─ 选择标注者: [下拉菜单] 李四 (@lisi)
│   └─ [📤 分配任务]
└─ 📊 所有任务分配状态:
    └─ [展开列表显示每个任务的分配状态]
```

## 🔒 权限控制

### 页面访问控制
```python
# 认证检查
if not require_authentication():
    return  # 显示登录页面

# 角色权限检查
if user['role'] == 'publisher':
    # 发布者可以访问所有功能
elif user['role'] == 'annotator':
    # 标注者只能访问指定功能
```

### 数据访问控制
```python
# 标注者只能看到分配给自己的任务
if user['role'] == 'annotator':
    tasks = db.get_user_assigned_tasks(user['id'])
else:
    tasks = db.get_all_tasks()
```

## 🚀 使用流程

### 初次使用流程

#### 1. 发布者注册
```
访问平台 → 注册页面 → 填写信息 → 输入邀请码"qijizhifeng" → 注册为发布者
```

#### 2. 标注者注册  
```
访问平台 → 注册页面 → 填写信息 → 不输入邀请码 → 注册为标注者
```

#### 3. 任务创建和分配
```
发布者登录 → 任务配置 → 创建任务 → 任务分配 → 选择标注者 → 分配任务
```

#### 4. 标注工作
```
标注者登录 → 我的任务 → 查看分配的任务 → 开始标注 → 完成标注
```

### 日常使用流程

#### 发布者工作流
1. **登录系统** → 查看总体进度
2. **创建任务** → 上传数据 → 配置字段和标注
3. **分配任务** → 选择标注者 → 执行分配
4. **监控进度** → 查看标注进度 → 跟进完成情况
5. **导出结果** → 下载标注数据

#### 标注者工作流
1. **登录系统** → 查看分配的任务
2. **选择任务** → 开始标注工作
3. **完成标注** → 保存结果 → 查看进度
4. **汇报完成** → 等待新任务分配

## 📊 状态显示

### 任务分配状态
- ✅ **已分配**: `👤 张三` - 显示分配的标注者
- ⚠️ **未分配**: 显示警告提示
- 🔄 **重新分配**: 显示历史分配记录

### 用户在线状态
- 🟢 **在线**: 当前登录用户
- ⭕ **离线**: 显示最后登录时间

### 进度统计
- **个人统计**: 标注者查看自己的任务进度
- **全局统计**: 发布者查看所有任务进度
- **分配统计**: 每个标注者的任务分配情况

## 🎉 功能优势

### 1. 安全性
- 密码哈希存储，防止明文泄露
- 基于角色的访问控制
- 会话管理和登录状态验证

### 2. 可管理性
- 清晰的角色划分和权限控制
- 完整的任务分配记录和状态跟踪
- 灵活的任务重新分配机制

### 3. 用户体验
- 直观的角色区分界面
- 个性化的任务列表显示
- 实时的进度和状态更新

### 4. 扩展性
- 支持添加更多用户角色
- 支持批量任务分配
- 支持用户组和团队管理

## 🔧 配置说明

### 邀请码配置
```python
# 在 streamlit_app.py 中修改
PUBLISHER_INVITE_CODE = "qijizhifeng"  # 发布者邀请码
```

### 角色权限配置
```python
# 用户角色常量
ROLE_PUBLISHER = "publisher"
ROLE_ANNOTATOR = "annotator"
```

所有功能已完全集成，重启应用即可使用新的账号管理系统！🎊
