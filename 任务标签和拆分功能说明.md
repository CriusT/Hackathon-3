# 任务标签和拆分功能说明

## 新增功能概述

本次更新为数据标注平台添加了两个重要的任务管理功能：任务标签和任务拆分。

### 1. 🏷️ 任务标签功能

#### 功能描述
发布者在创建任务时可以为任务添加标签，用于标识数据类型和便于任务分类管理。

#### 支持的标签类型
- **SQL** 🗃️ - SQL相关的数据标注任务
- **数学** 🔢 - 数学问题和计算相关的标注任务  
- **DeepResearch** 🔬 - 深度研究和分析相关的标注任务

#### 主要特性
1. **标签选择**
   - 在任务确认步骤中提供下拉选择框
   - 支持不选择标签（留空）
   - 标签信息存储在数据库中

2. **标签显示**
   - 任务列表中显示对应的emoji图标和标签名称
   - 任务详情页面展示标签信息
   - 便于用户快速识别任务类型

3. **数据库存储**
   - 新增 `task_label` 字段存储标签信息
   - 支持现有数据库的平滑升级

### 2. ✂️ 任务拆分功能

#### 功能描述
发布者可以将一个大的任务拆分成多个独立的子任务，每个子任务包含原始数据的一部分，可以分配给不同的标注者并行处理。

#### 主要特性

1. **智能拆分算法**
   - 支持将数据不重复地均匀拆分
   - 自动处理不整除的情况，确保数据分配合理
   - 例如：10条数据拆分成3份 → 4条、3条、3条

2. **拆分配置**
   - 可选择是否启用拆分（默认不启用）
   - 支持2-10个子任务的拆分
   - 实时预览拆分结果

3. **子任务管理**
   - 每个子任务都是独立的任务实体
   - 自动生成子任务名称（如"任务名 (第1部分)"）
   - 包含拆分信息（第x部分，共y部分）

4. **数据文件管理**
   - 自动创建 `data/splits/` 目录存储拆分数据
   - 每个子任务有独立的JSONL数据文件
   - 文件命名规则：`split_X_of_Y_任务名.jsonl`

#### 数据库设计

新增字段：
- `parent_task_id`: 父任务ID（拆分任务的共同标识）
- `split_index`: 拆分索引（从0开始）
- `total_splits`: 总拆分数量

#### 拆分示例

**原始任务**: 100条数据，拆分成3个子任务
- 子任务1: 34条数据 (索引0-33)
- 子任务2: 33条数据 (索引34-66)  
- 子任务3: 33条数据 (索引67-99)

## 用户界面改进

### 任务配置页面

在"任务确认"步骤中新增：

1. **任务标签选择区域**
   ```
   任务标签:
   [下拉选择框: "", "SQL", "数学", "DeepResearch"]
   ```

2. **任务拆分配置区域**
   ```
   任务拆分:
   [☐] 启用任务拆分    [数量输入框: 2-10]
   
   拆分预览:
   • 第1部分: X 条数据
   • 第2部分: Y 条数据
   ...
   ```

### 任务显示优化

1. **任务列表标题**
   - 原格式：`📝 任务名 - 进度%`
   - 新格式：`📝 任务名 🗃️SQL (第1部分) - 进度%`

2. **任务详情信息**
   - 显示任务标签
   - 显示拆分信息（如果是拆分任务）
   - 显示数据量和完成情况

## 技术实现

### 数据库更新

1. **Schema变更**
   ```sql
   ALTER TABLE tasks ADD COLUMN task_label TEXT;
   ALTER TABLE tasks ADD COLUMN parent_task_id TEXT;
   ALTER TABLE tasks ADD COLUMN split_index INTEGER DEFAULT 0;
   ALTER TABLE tasks ADD COLUMN total_splits INTEGER DEFAULT 1;
   ```

2. **自动迁移**
   - 应用启动时自动检测并添加缺失的列
   - 兼容现有数据，默认值处理

### 核心方法

1. **`create_split_tasks()`**
   - 处理任务拆分逻辑
   - 数据文件分割和保存
   - 子任务创建和关联

2. **更新的 `create_task()` 方法**
   - 支持新字段的存储
   - 向后兼容旧格式

3. **更新的 `get_task()` 和 `get_all_tasks()` 方法**
   - 返回新字段信息
   - 处理字段缺失的情况

### 文件系统

```
data/
├── task_data_*.jsonl          # 原始任务数据
└── splits/                    # 拆分任务数据目录
    ├── split_1_of_3_任务A.jsonl
    ├── split_2_of_3_任务A.jsonl
    └── split_3_of_3_任务A.jsonl
```

## 用户工作流程

### 发布者创建任务流程

1. **上传数据文件** → 选择字段 → 配置标注
2. **任务确认步骤**:
   - 输入任务名称和描述
   - 选择任务标签（可选）
   - 选择是否启用拆分
   - 如果启用拆分，选择拆分数量
   - 查看配置摘要
3. **创建任务**:
   - 单任务：直接创建，可立即开始标注
   - 拆分任务：创建多个子任务，建议在任务分配页面分配

### 任务分配策略

1. **单任务**: 可分配给一个标注者
2. **拆分任务**: 建议将不同子任务分配给不同标注者，提高并行处理效率

## 优势和应用场景

### 任务标签优势
- **分类管理**: 便于按数据类型筛选和管理任务
- **专业匹配**: 可根据标注者专业领域分配相应类型任务
- **统计分析**: 便于按标签统计标注进度和质量

### 任务拆分优势
- **并行处理**: 多个标注者同时工作，提高整体效率
- **负载均衡**: 合理分配工作量，避免单个标注者负担过重
- **风险分散**: 降低单点故障影响，提高任务完成的可靠性
- **灵活分配**: 可根据标注者能力和时间安排分配不同大小的子任务

### 应用场景

1. **大型标注项目**: 将万条数据拆分给10个标注者并行处理
2. **专业分工**: SQL任务分配给技术人员，数学任务分配给数学专家
3. **质量控制**: 同类型任务可分配给相同专业背景的标注者
4. **进度管理**: 通过子任务独立跟踪，更精确掌握项目进度

## 兼容性和升级

- ✅ 向后兼容现有任务数据
- ✅ 自动数据库迁移，无需手动操作
- ✅ 现有功能不受影响
- ✅ 支持混合使用（标签、拆分可独立启用）

## 后续扩展建议

1. **标签管理**: 支持自定义标签类型
2. **智能拆分**: 基于数据复杂度自动建议拆分数量
3. **拆分模板**: 保存常用的拆分配置
4. **任务合并**: 支持将子任务结果合并导出
5. **标签筛选**: 在任务列表中支持按标签筛选
